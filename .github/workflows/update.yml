name: Auto-Update playlist.m3u

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build playlist.m3u (bash)
        shell: bash
        run: |
          set -euo pipefail

          OUT="playlist.m3u"
          JIO_SOURCE="https://livetv-cb7.pages.dev/hotstar"
          ZEE_SOURCE="https://join-vaathala1-for-more.vodep39240327.workers.dev/zee5.m3u"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"

          # Fetch Jio token (optional; no Jio channel list provided to apply it to)
          JIO_TOKEN="$(
            curl -fsSL -A "$UA" "$JIO_SOURCE" \
            | grep -oE '__hdnea__=[^"&[:space:]]+' \
            | head -n1 || true
          )"

          # Fetch Zee playlist (required)
          ZEE_M3U="$(curl -fsSL -A "$UA" "$ZEE_SOURCE")"

          # Extract Zee token (optional)
          ZEE_TOKEN="$(printf '%s' "$ZEE_M3U" | grep -oE 'hdntl=[^"'"'"'[:space:]]+' | head -n1 || true)"

          # Start output
          {
            echo "#EXTM3U"
            printf '%s\n' "$ZEE_M3U" | awk -v token="$ZEE_TOKEN" '
              BEGIN { printedHeader=0 }
              {
                line=$0
                # Skip duplicate #EXTM3U from source
                if (line ~ /^#EXTM3U$/) next

                # If we have a token and this is a .m3u8 URL, rewrite to base + ?token
                if (token != "" && line ~ /\.m3u8/) {
                  # remove any existing querystring
                  sub(/\?.*$/, "", line)
                  # ensure ends at .m3u8 (handles stray text after)
                  if (match(line, /\.m3u8/)) line = substr(line, 1, RSTART+RLENGTH-1)
                  print line "?" token
                  next
                }
                print $0
              }
            '

            if [ -n "${JIO_TOKEN:-}" ]; then
              echo
              echo "# ---- JIO TOKEN (not applied; no Jio entries provided) ----"
              echo "# ${JIO_TOKEN}"
            fi
          } > "$OUT"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add playlist.m3u
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "✅ Auto-update playlist.m3u"
          git push origin main